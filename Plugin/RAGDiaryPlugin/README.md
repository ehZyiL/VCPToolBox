# RAGDiaryPlugin - 智能日记检索插件使用手册

## 概述

`RAGDiaryPlugin` 是一个强大的消息预处理器，它极大地增强了与角色日记内容的交互能力。通过引入基于向量相似度的检索增强生成（RAG）技术，本插件允许用户在对话中以多种智能方式动态地、精确地调用角色的日记信息。

除了服务器原生的 `{{角色日记本}}` 全文注入模式外，本插件额外提供了三种高级调用模式，使得日记内容的利用更加灵活和上下文感知。

---

## 四种日记调用模式详解

根据您的具体需求，可以选择最合适的模式来调用日记内容：

### 1. `{{角色日记本}}` (服务器原生)

-   **工作模式**：**无条件全文注入**。
-   **描述**：这是服务器内置的、最基础的日记调用方式。一旦在System Prompt中检测到此语法，它会**无条件地**将指定角色的**所有**日记内容完整地注入到上下文中。
-   **适用场景**：当您需要角色完整回顾其所有记忆，或者需要对整个日记进行全面总结时。
-   **注意**：此模式不受本插件的任何智能检索逻辑控制。

### 2. `[[角色日记本]]` (插件)

-   **工作模式**：**无条件 RAG 片段检索**。
-   **描述**：此模式会忽略相似度判断，直接根据当前对话的上下文（通常是用户的最新消息），从指定的日记向量数据库中检索出最相关的**记忆片段**。
-   **支持动态K值**：是。您可以使用 `[[角色日记本:1.5]]` 的语法来调整检索片段的数量（`1.5` 是一个乘数，会乘以插件动态计算出的基础K值）。
-   **适用场景**：当您明确知道需要根据当前话题从日记中寻找相关信息，但又不希望注入全部内容时。

### 3. `<<角色日记本>>` (插件)

-   **工作模式**：**基于相似度阈值的全文注入**。
-   **描述**：这是一种智能的全文注入模式。插件会首先计算当前对话上下文与该“日记本”主题（基于其名称和预设标签）的向量相似度。**只有当相似度超过预设的阈值时**，才会将该角色的**全部**日记内容注入。
-   **适用场景**：适用于那些不确定当前对话是否与某个角色的日记高度相关，希望由AI自动判断是否需要加载其完整背景故事的场合。可以有效避免无关日记内容对上下文的污染。

### 4. `《《角色日记本》》` (插件) - **混合模式**

-   **工作模式**：**基于相似度阈值的 RAG 片段检索**。
-   **描述**：这是最智能、最灵活的模式，它结合了 `<<>>` 和 `[[]]` 的优点。它会先像 `<<>>` 模式一样进行相似度评估，**只有当相似度达标后**，才会像 `[[]]` 模式一样，去检索相关的**记忆片段**而非注入全文。
-   **支持动态K值**：是。同样支持 `《《角色日记本:1.5》》` 语法。
-   **适用场景**：最推荐的日常使用模式。它既能通过阈值判断避免无关信息的干扰，又能在相关时只提取最关键的记忆片段，最大限度地保证了上下文的精确性和高效性。

---

## 高级功能与配置

### 动态K值

对于 `[[]]` 和 `《《》》` 模式，您可以通过在末尾添加 `:乘数` 的方式来动态调整检索结果的数量。例如，`:1.5` 会将默认检索数量乘以1.5，而 `:0.5` 则会减半。这为您提供了更精细的控制。

### 标签 (Tags) 与阈值 (Threshold)

`<<>>` 和 `《《》》` 模式的相似度判断能力可以通过在 `rag_tags.json` 文件中设置标签和独立阈值来增强。

-   **Tags**: 您可以为每个日记本定义一组核心标签和权重（如 `"tags": ["战斗:1.2", "情感", "家庭:0.8"]`），插件会根据这些标签生成一个“增强向量”，使其能更准确地理解日记本的核心主题。
-   **Threshold**: 您可以为每个日记本设置一个独立的相似度阈值，覆盖全局默认值，以实现更精细的控制。

---

## 强烈建议：使用服务器管理面板

手动编辑 `rag_tags.json` 文件可能比较复杂且容易出错。

我们强烈建议您使用服务器自带的管理面板来管理所有与日记相关的数据和配置。在管理面板中，您可以方便地：

-   **查看和编辑每个角色的日记内容**。
-   **为日记本添加、删除和调整带权重的标签 (Tags)**。
-   **为每个日记本独立设置相似度阈值 (Threshold)**。
-   **一键重建向量缓存**。

请访问您的服务器主页，通常可以在设置或插件管理区域找到相关入口。这将为您提供一个直观、高效的图形化界面来充分利用本插件的全部功能。